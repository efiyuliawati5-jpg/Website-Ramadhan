<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadhan Ceria - Jurnal Ibadahku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #a7f3d0 0%, #34d399 100%);
            min-height: 100vh;
        }
        .font-kids { font-family: 'Fredoka One', cursive; }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: #f59e0b;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 0 #b45309;
        }
        .btn-primary:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        .step-transition {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .star-animation {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #34d399;
            border-radius: 10px;
        }
        table { border-collapse: separate; border-spacing: 0; }
        th { background: #34d399; color: white; }
        tr:nth-child(even) { background: #f0fdf4; }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center">

    <div id="app" class="w-full max-w-4xl">
        <!-- Progress Bar -->
        <div id="progress-container" v-if="currentStep > 0 && currentStep < 7 && !showRekap" class="mb-6 flex justify-between gap-1 max-w-md mx-auto">
            <template v-for="i in 8">
                <div :class="['h-2 flex-1 rounded-full', currentStep >= i-1 ? 'bg-orange-400' : 'bg-white/50']"></div>
            </template>
        </div>

        <!-- Main Card -->
        <div v-if="!showRekap" class="card p-8 relative overflow-hidden max-w-md mx-auto">
            
            <!-- Halaman 0: Login -->
            <div v-if="currentStep === 0" class="step-transition text-center">
                <div class="text-6xl mb-4">üåô</div>
                <h1 class="font-kids text-2xl text-green-700 mb-2 leading-tight">Assalamu'alaikum anak sholih dan sholihah!</h1>
                <p class="text-gray-600 mb-6 italic text-sm">Mari kita catat tabungan pahala hari ini</p>
                <input v-model="formData.nama" type="text" placeholder="Tulis namamu di sini..." class="w-full p-4 border-2 border-green-200 rounded-xl mb-4 focus:outline-none focus:border-green-500 text-center font-bold text-lg">
                <div class="space-y-3">
                    <button @click="nextStep" :disabled="!formData.nama" class="btn-primary w-full py-4 rounded-xl font-kids text-lg disabled:opacity-50 uppercase">Ayo Mulai!</button>
                    <button @click="openRekap" class="text-green-700 font-bold text-sm underline">Lihat Rekap Seluruh Hari</button>
                </div>
            </div>

            <!-- Halaman 1: Sambutan -->
            <div v-if="currentStep === 1" class="step-transition">
                <h1 class="font-kids text-2xl text-green-700 mb-4 text-center">Halo, {{ formData.nama }}! üëã</h1>
                <p class="text-gray-700 text-center mb-6 leading-relaxed">
                    Senang sekali kamu sudah siap beribadah! Di sini kamu bisa mencatat semua kebaikan yang sudah dilakukan. Semangat terus puasanya ya!
                </p>
                <button @click="nextStep" class="btn-primary w-full py-4 rounded-xl font-kids text-lg uppercase">Lanjut</button>
            </div>

            <!-- Halaman 2: Aturan -->
            <div v-if="currentStep === 2" class="step-transition">
                <h1 class="font-kids text-xl text-green-700 mb-4 text-center">üìú Cara Mengisi Jurnal</h1>
                <div class="bg-blue-50 p-4 rounded-2xl mb-6 text-sm text-blue-800 leading-relaxed border border-blue-100">
                    <p class="font-bold mb-2">Petunjuk Penting:</p>
                    Isilah jurnal ini setiap hari sebelum tidur agar tidak lupa. Data akan terekap otomatis ke dalam tabel rahasiamu!
                </div>
                <ul class="space-y-4 mb-6 text-gray-700">
                    <li class="flex items-start gap-3">
                        <span class="bg-green-100 p-1 rounded-full text-xs">1Ô∏è‚É£</span>
                        <span><strong>Pilih:</strong> Tekan kotak kegiatan yang sudah selesai.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="bg-green-100 p-1 rounded-full text-xs">2Ô∏è‚É£</span>
                        <span><strong>Cerita:</strong> Tulis pengalamanmu minimal 20 huruf.</span>
                    </li>
                </ul>
                <button @click="nextStep" class="btn-primary w-full py-4 rounded-xl font-kids text-lg uppercase">Saya Mengerti!</button>
            </div>

            <!-- Halaman 3: Pilih Kegiatan -->
            <div v-if="currentStep === 3" class="step-transition">
                <h1 class="font-kids text-xl text-green-700 mb-2 text-center">Kegiatanmu Hari Ini?</h1>
                <div class="grid grid-cols-2 gap-3 mb-6 max-h-[320px] overflow-y-auto pr-2 custom-scroll">
                    <button v-for="act in activities" :key="act.id" 
                            @click="toggleActivity(act.id)"
                            :class="['p-3 border-2 rounded-xl text-[13px] font-semibold transition-all flex flex-col items-center justify-center text-center', 
                                    formData.kegiatan.includes(act.id) ? 'bg-green-500 border-green-600 text-white scale-95' : 'bg-white border-green-100 text-green-700']">
                        <span class="text-2xl mb-1">{{ act.icon }}</span>
                        {{ act.name }}
                    </button>
                </div>
                <button @click="nextStep" :disabled="formData.kegiatan.length === 0" class="btn-primary w-full py-4 rounded-xl font-kids text-lg uppercase disabled:opacity-50">Lanjut</button>
            </div>

            <!-- Halaman 4: Deskripsi -->
            <div v-if="currentStep === 4" class="step-transition">
                <h1 class="font-kids text-xl text-green-700 mb-2 text-center">Ceritakan dong! ‚úçÔ∏è</h1>
                <textarea v-model="formData.deskripsi" rows="4" placeholder="Hari ini aku belajar..." 
                          class="w-full p-4 border-2 border-green-200 rounded-xl mb-2 focus:outline-none focus:border-green-500"></textarea>
                <div class="text-right text-xs mb-6" :class="formData.deskripsi.length >= 20 ? 'text-green-600' : 'text-red-400'">
                    Karakter: {{ formData.deskripsi.length }} / 20
                </div>
                <button @click="nextStep" :disabled="formData.deskripsi.length < 20" class="btn-primary w-full py-4 rounded-xl font-kids text-lg uppercase disabled:opacity-50">Lanjut</button>
            </div>

            <!-- Halaman 5: Upload Foto -->
            <div v-if="currentStep === 5" class="step-transition text-center">
                <h1 class="font-kids text-xl text-green-700 mb-4">Upload Fotomu üì∏</h1>
                <div class="relative w-full aspect-square bg-gray-100 rounded-2xl border-4 border-dashed border-green-200 flex items-center justify-center mb-6 overflow-hidden">
                    <img v-if="formData.foto" :src="formData.foto" class="w-full h-full object-cover">
                    <div v-else class="text-gray-400">
                        <p class="text-4xl mb-2">‚ûï</p>
                        <p class="text-sm">Klik untuk pilih foto</p>
                    </div>
                    <input type="file" @change="handleFileUpload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
                <button @click="nextStep" :disabled="!formData.foto || isCompressing" class="btn-primary w-full py-4 rounded-xl font-kids text-lg uppercase disabled:opacity-50">
                    {{ isCompressing ? 'Merapikan Foto...' : 'Lanjut' }}
                </button>
            </div>

            <!-- Halaman 6: Review & Simpan -->
            <div v-if="currentStep === 6" class="step-transition">
                <h1 class="font-kids text-xl text-green-700 mb-4 text-center">Periksa Lagi Ya! üßê</h1>
                <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scroll mb-6">
                    <div class="bg-green-50 p-3 rounded-xl">
                        <p class="text-[10px] text-green-600 font-bold">NAMA</p>
                        <p class="font-bold text-sm">{{ formData.nama }}</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-xl text-sm">
                        <p class="text-[10px] text-green-600 font-bold uppercase">Kegiatan</p>
                        {{ selectedActivitiesText }}
                    </div>
                </div>
                <button @click="submitData" :disabled="isSubmitting" class="btn-primary w-full py-4 rounded-xl font-kids text-lg uppercase">
                    {{ isSubmitting ? 'Menyimpan...' : 'Kirim Sekarang! üöÄ' }}
                </button>
            </div>

            <!-- Halaman 7: Selesai -->
            <div v-if="currentStep === 7" class="step-transition text-center">
                <div class="star-animation text-8xl mb-6">‚≠ê</div>
                <h1 class="font-kids text-3xl text-orange-500 mb-2 uppercase">Alhamdulillah!</h1>
                <p class="text-gray-600 mb-8 font-semibold">Kamu hebat, {{ formData.nama }}! <br> Satu bintang untukmu hari ini.</p>
                <button @click="resetApp" class="bg-green-500 text-white w-full py-4 rounded-xl font-kids text-lg uppercase">Isi Lagi Besok</button>
                <button @click="openRekap" class="mt-4 text-green-700 font-bold text-sm underline block mx-auto">Lihat Rekap Jurnal</button>
            </div>
        </div>

        <!-- Spreadsheet View (Rekap) -->
        <div v-if="showRekap" class="card p-4 md:p-8 w-full">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="font-kids text-2xl text-green-700">üìä Spreadsheet Jurnal Ramadhan</h1>
                <button @click="showRekap = false" class="bg-gray-200 px-6 py-2 rounded-xl font-bold text-sm">Kembali</button>
            </div>
            
            <div class="overflow-x-auto rounded-xl border border-gray-200 custom-scroll">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr>
                            <th class="p-4 whitespace-nowrap">Tanggal</th>
                            <th class="p-4 whitespace-nowrap">Nama</th>
                            <th class="p-4">Kegiatan yang Dilakukan</th>
                            <th class="p-4">Cerita Seru</th>
                            <th class="p-4">Foto</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="log in logs" :key="log.id">
                            <td class="p-4 font-bold whitespace-nowrap">{{ formatDate(log.timestamp) }}</td>
                            <td class="p-4">{{ log.nama }}</td>
                            <td class="p-4 italic">{{ log.kegiatanText }}</td>
                            <td class="p-4 max-w-xs">{{ log.deskripsi }}</td>
                            <td class="p-4">
                                <img :src="log.foto" class="w-12 h-12 object-cover rounded-lg shadow-sm border border-gray-100">
                            </td>
                        </tr>
                        <tr v-if="logs.length === 0">
                            <td colspan="5" class="p-10 text-center text-gray-400 font-bold">Belum ada data terekap. Ayo isi jurnalmu!</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Vue Global (Load before Firebase module) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Access Vue from global window object because we are inside a module script
        const { createApp, ref, computed, onMounted } = window.Vue;

        createApp({
            setup() {
                const currentStep = ref(0);
                const isCompressing = ref(false);
                const isSubmitting = ref(false);
                const showRekap = ref(false);
                const user = ref(null);
                const logs = ref([]);

                // Firebase Config
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ramadhan-jurnal-kids';

                const activities = [
                    { id: 1, name: 'Makan Sahur', icon: 'üç≤' },
                    { id: 2, name: 'Sholat Subuh', icon: 'üåÖ' },
                    { id: 3, name: 'Sholat Dzuhur', icon: '‚òÄÔ∏è' },
                    { id: 4, name: 'Sholat Ashar', icon: 'üå§Ô∏è' },
                    { id: 5, name: 'Berbuka & Maghrib', icon: 'üçπ' },
                    { id: 6, name: 'Sholat Isya', icon: 'üåÉ' },
                    { id: 7, name: 'Sholat Tarawih', icon: 'üåô' },
                    { id: 8, name: 'Bersedekah', icon: 'üí∞' },
                    { id: 9, name: 'Tadarus Al-Quran', icon: 'üìñ' },
                    { id: 10, name: 'Puasa Seharian', icon: '‚ú®' }
                ];

                const formData = ref({
                    nama: '',
                    kegiatan: [],
                    deskripsi: '',
                    foto: null
                });

                // Auth Logic
                onMounted(async () => {
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (err) {
                            console.error("Auth Error:", err);
                        }
                    };
                    await initAuth();
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        if (u) loadLogs();
                    });
                });

                const loadLogs = () => {
                    if (!user.value) return;
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'jurnal_harian'));
                    onSnapshot(q, (snapshot) => {
                        logs.value = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    }, (err) => console.error("Firestore Error:", err));
                };

                const submitData = async () => {
                    if (!user.value || isSubmitting.value) return;
                    isSubmitting.value = true;
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'jurnal_harian'), {
                            nama: formData.value.nama,
                            kegiatanIds: formData.value.kegiatan,
                            kegiatanText: selectedActivitiesText.value,
                            deskripsi: formData.value.deskripsi,
                            foto: formData.value.foto,
                            userId: user.value.uid,
                            timestamp: serverTimestamp()
                        });
                        currentStep.value = 7;
                    } catch (e) {
                        console.error("Gagal simpan:", e);
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const nextStep = () => {
                    if (currentStep.value < 7) {
                        currentStep.value++;
                        if (currentStep.value === 1) {
                            // Vue handles visibility through v-if, no need for manual DOM manipulation usually
                        }
                    }
                };

                const toggleActivity = (id) => {
                    const index = formData.value.kegiatan.indexOf(id);
                    if (index === -1) formData.value.kegiatan.push(id);
                    else formData.value.kegiatan.splice(index, 1);
                };

                const selectedActivitiesText = computed(() => {
                    return formData.value.kegiatan
                        .map(id => activities.find(a => a.id === id)?.name || '')
                        .join(', ');
                });

                const handleFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    isCompressing.value = true;
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 600;
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            formData.value.foto = canvas.toDataURL('image/jpeg', 0.6);
                            isCompressing.value = false;
                        };
                    };
                };

                const formatDate = (ts) => {
                    if (!ts) return 'Memproses...';
                    const d = ts.toDate ? ts.toDate() : new Date();
                    return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                };

                const resetApp = () => {
                    currentStep.value = 0;
                    const savedNama = formData.value.nama;
                    formData.value = { nama: savedNama, kegiatan: [], deskripsi: '', foto: null };
                };

                const openRekap = () => {
                    showRekap.value = true;
                };

                return {
                    currentStep, formData, activities, nextStep, toggleActivity, 
                    handleFileUpload, selectedActivitiesText, isCompressing, resetApp,
                    isSubmitting, submitData, showRekap, logs, formatDate, openRekap
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
